<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo IoT MÃ³vil</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 10px; }
        .stats-container { background: #1e1e1e; padding: 15px; margin-bottom: 20px; border-radius: 15px; border: 1px solid #333; }
        #total-count { font-size: 3em; color: #00e676; font-weight: bold; }
        
        .status-bar { margin-bottom: 15px; font-size: 0.9em; padding: 5px; border-radius: 5px; background: #252525; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; padding: 10px; }
        .sensor-card { background: #252525; padding: 15px; border-radius: 12px; border: 1px solid #333; transition: 0.3s; }
        
        .active { background: #0061ff !important; border-color: #00d4ff; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 97, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 97, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 97, 255, 0); }
        }

        .count-label { font-size: 0.8em; color: #999; margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; }
        
        /* Panel de Control de Reinicio */
        .control-panel { margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 10px; border: 1px dashed #444; }
        .btn-danger { background: #ff5252; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; }
        .btn-danger:hover { background: #ff1744; }
        .btn-danger:disabled { background: #555; cursor: not-allowed; }

        .history-container { margin-top: 20px; background: #1e1e1e; padding: 10px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th { color: #888; border-bottom: 1px solid #333; padding: 5px; }
        td { padding: 8px; border-bottom: 1px solid #252525; }
    </style>
</head>
<body>

    <div class="stats-container">
        <div class="status-bar">
            Estado: <span id="esp-status">Cargando...</span>
        </div>
        <span id="total-count">0</span>
        <div style="color: #888;">Descargas Totales</div>
    </div>
    
    <div class="grid" id="sensor-grid">
        {% for i in range(16) %}
        <div id="sensor-{{i}}" class="sensor-card">
            <div style="font-size: 0.7em; color: #777;">PIN {{pines[i]}}</div>
            <div id="val-{{i}}" style="margin: 5px 0; font-weight: bold;">REPOSO</div>
            <div class="count-label">Total: <span id="count-{{i}}" style="color: #00e5ff;">0</span></div>
        </div>
        {% endfor %}
    </div>

    <div class="control-panel">
        <button id="btn-reinicio" class="btn-danger" onclick="confirmarReinicio()">
            REINICIAR ESP32 AHORA
        </button>
    </div>

    <div class="history-container">
        <h3>Ãšltimos Eventos</h3>
        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Sensor</th>
                    <th>Pulsos</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla"></tbody>
        </table>
    </div>

    <script>
        function updateDashboard() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusText = document.getElementById('esp-status');
                    if (data.esp_online) {
                        statusText.innerText = "â— Conectado (" + data.esp_ip + ")";
                        statusText.style.color = "#00e676";
                    } else {
                        statusText.innerText = "â—‹ Desconectado";
                        statusText.style.color = "#ff5252";
                    }

                    document.getElementById('total-count').innerText = data.total_global;

                    let tablaHTML = "";
                    data.recientes.slice().reverse().forEach(ev => {
                        tablaHTML += `<tr><td>${ev.hora}</td><td>ID_${ev.sensor}</td><td>${ev.intensidad}</td></tr>`;
                    });
                    document.getElementById('cuerpo-tabla').innerHTML = tablaHTML;

                    data.sensors.forEach((s, index) => {
                        const card = document.getElementById('sensor-' + index);
                        const valText = document.getElementById('val-' + index);
                        const countText = document.getElementById('count-' + index);
                        if (card) {
                            countText.innerText = s.count;
                            if (s.active) {
                                card.classList.add('active');
                                valText.innerText = s.intensity + " PULSOS";
                            } else {
                                card.classList.remove('active');
                                valText.innerText = "REPOSO";
                            }
                        }
                    });
                });
        }

        function confirmarReinicio() {
            if (confirm("Â¿Reiniciar hardware?")) {
                const btn = document.getElementById('btn-reinicio');
                btn.disabled = true;
                btn.innerText = "Enviando...";
                fetch('/mandar_reinicio', { method: 'POST' })
                    .then(r => alert(r.ok ? "ðŸš€ Orden enviada" : "âŒ No responde"))
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerText = "REINICIAR ESP32 AHORA";
                    });
            }
        }

        setInterval(updateDashboard, 1000);
    </script>
</body>
</html>